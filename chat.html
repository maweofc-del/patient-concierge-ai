<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Concierge AI ‚Äî Chat</title>
  <meta name="description" content="Patient Concierge AI ‚Äî dental booking chatbot." />

  <style>
    :root{
      --bg:#f7fbff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --brand:#2563eb;
      --brand2:#0ea5e9;
      --ok:#16a34a;
      --border:rgba(15,23,42,.10);
      --shadow:0 18px 55px rgba(2,6,23,.10);
      --radius:18px;

      --botBubble: rgba(37,99,235,.08);
      --userBubble: rgba(22,163,74,.10);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 0%, rgba(14,165,233,.10), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(22,163,74,.10), transparent 60%),
        linear-gradient(180deg,#ffffff,var(--bg));
      min-height:100vh;
    }
    a{color:inherit}

    .wrap{max-width:980px;margin:0 auto;padding:18px 14px 26px}
    .top{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:10px 4px 14px;
    }
    .brand{display:flex;align-items:center;gap:10px;text-decoration:none}
    .logo{
      width:44px;height:44px;border-radius:16px;
      background:linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid;place-items:center;
      color:#fff;font-weight:900;letter-spacing:.4px;
      box-shadow:0 14px 35px rgba(37,99,235,.20);
      flex:0 0 auto;
    }
    .brandMeta{line-height:1.1}
    .brandMeta b{display:block;font-size:15px}
    .brandMeta small{display:block;color:var(--muted);font-size:12px;margin-top:2px}
    .pill{
      display:inline-flex;align-items:center;gap:8px;
      padding:8px 12px;border-radius:999px;
      border:1px solid var(--border);
      background:rgba(255,255,255,.70);
      color:var(--muted);font-size:13px;font-weight:700;
      white-space:nowrap;
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:22px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .cardTop{
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:14px 14px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg,#ffffff,#f4fbff);
    }
    .cardTop .title{font-weight:900}
    .status{display:flex;align-items:center;gap:8px;color:var(--ok);font-weight:900;font-size:12px}
    .dot{width:8px;height:8px;border-radius:99px;background:var(--ok)}
    .subhead{padding:10px 14px;color:var(--muted);font-size:13px;line-height:1.5;border-bottom:1px solid var(--border)}

    .chat{
      height:min(62vh, 520px);
      overflow:auto;
      padding:14px;
      background:linear-gradient(180deg,#ffffff,#fbfeff);
    }
    .row{display:flex;margin:10px 0}
    .row.bot{justify-content:flex-start}
    .row.user{justify-content:flex-end}
    .bubble{
      max-width:min(78%, 520px);
      padding:10px 12px;
      border-radius:14px;
      font-size:13px;
      line-height:1.4;
      border:1px solid var(--border);
      box-shadow:0 6px 18px rgba(2,6,23,.04);
      white-space:pre-wrap;
    }
    .bot .bubble{background:var(--botBubble)}
    .user .bubble{background:var(--userBubble)}

    .inputBar{
      border-top:1px solid var(--border);
      padding:12px;
      display:flex;gap:10px;align-items:flex-end;
      background:#fff;
    }
    .field{
      flex:1;
      display:flex;flex-direction:column;gap:6px;
    }
    .label{font-size:12px;color:var(--muted);font-weight:700}
    .inp, .sel, .txt{
      width:100%;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px 12px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .txt{min-height:44px;resize:vertical}
    .btn{
      appearance:none;border:0;cursor:pointer;text-decoration:none;
      display:inline-flex;align-items:center;justify-content:center;gap:10px;
      padding:12px 14px;border-radius:14px;font-weight:900;
      transition: transform .08s ease, filter .2s ease, background .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform:translateY(-1px);filter:brightness(1.02)}
    .btnPrimary{background:linear-gradient(135deg,var(--brand),var(--brand2)); color:#fff}
    .btnGhost{background:#fff;border:1px solid var(--border); color:var(--text)}
    .btnSmall{padding:10px 12px;border-radius:12px;font-size:13px}

    .quick{
      display:flex;flex-wrap:wrap;gap:8px;
      padding:12px 14px;
      border-top:1px solid var(--border);
      background:rgba(255,255,255,.7);
    }
    .qbtn{
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:8px 10px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
    }
    .qbtn:hover{filter:brightness(1.02)}
    .muted{color:var(--muted)}
    .footerNote{margin-top:12px;color:var(--muted);font-size:12px;text-align:center;line-height:1.5}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a class="brand" href="./">
        <div class="logo">PC</div>
        <div class="brandMeta">
          <b>Patient Concierge AI</b>
          <small>Dental Booking Chatbot</small>
        </div>
      </a>
      <div id="modePill" class="pill">‚úÖ Ready</div>
    </div>

    <div class="card">
      <div class="cardTop">
        <div class="title">Chat Intake</div>
        <div class="status"><span class="dot"></span> Online</div>
      </div>
      <div class="subhead">
        This chat collects your request and sends it to the clinic instantly.
        <span class="muted">Final suitability and pricing are confirmed by the clinic.</span>
      </div>

      <div id="chat" class="chat"></div>

      <div id="quick" class="quick" style="display:none;"></div>

      <div class="inputBar">
        <div class="field">
          <div id="inputLabel" class="label">Your answer</div>
          <input id="input" class="inp" placeholder="Type here‚Ä¶" autocomplete="off" />
        </div>
        <button id="sendBtn" class="btn btnPrimary">Send</button>
      </div>
    </div>

    <div class="footerNote">
      Tip for clinics: share the demo link <b>chat.html?demo=1</b> so they can enter their email and test it.
    </div>
  </div>
    <script>
    // =========================
    // CONFIG (already your live Apps Script URL)
    // =========================
    const MAILER_URL = "https://script.google.com/macros/s/AKfycbwobfSvAaRJi7XKOekFQf5a7uVDIFaYwdsFkHnEsn35sQNFWgsZQtzwqNJAaGNxRcEE/exec";

    // =========================
    // STATE
    // =========================
    const qs = new URLSearchParams(location.search);
    const isDemo = qs.get("demo") === "1";

    const state = {
      mode: isDemo ? "DEMO" : "LIVE",
      demoEmail: "",
      service: "",
      patientName: "",
      patientPhone: "",
      patientEmail: "",
      preferredTime: "",
      notes: "",
      sourcePage: document.referrer || location.href
    };

    const chatEl = document.getElementById("chat");
    const quickEl = document.getElementById("quick");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const inputLabel = document.getElementById("inputLabel");
    const modePill = document.getElementById("modePill");

    modePill.textContent = isDemo ? "üß™ Demo mode" : "‚úÖ Live mode";

    // =========================
    // UI HELPERS
    // =========================
    function scrollDown() {
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    function addMsg(text, who = "bot") {
      const row = document.createElement("div");
      row.className = "row " + (who === "user" ? "user" : "bot");
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.appendChild(bubble);
      chatEl.appendChild(row);
      scrollDown();
    }

    function setQuickButtons(options) {
      quickEl.innerHTML = "";
      if (!options || !options.length) {
        quickEl.style.display = "none";
        return;
      }
      quickEl.style.display = "flex";
      options.forEach(opt => {
        const b = document.createElement("button");
        b.className = "qbtn";
        b.type = "button";
        b.textContent = opt;
        b.onclick = () => {
          addMsg(opt, "user");
          quickEl.style.display = "none";
          handleAnswer(opt);
        };
        quickEl.appendChild(b);
      });
    }

    function setInput(placeholder, label="Your answer", type="text") {
      inputLabel.textContent = label;
      inputEl.placeholder = placeholder;
      inputEl.type = type;
      inputEl.value = "";
      inputEl.focus();
    }

    function isValidEmail(s) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(s).trim());
    }

    function normalizePhone(s) {
      return String(s).trim();
    }

    // =========================
    // FLOW (simple state machine)
    // =========================
    const steps = [];
    let stepIndex = 0;

    function buildSteps() {
      steps.length = 0;

      if (isDemo) {
        steps.push({
          key: "demoEmail",
          bot: "Demo setup: what email should receive the test lead summary?",
          placeholder: "Enter your email (e.g. clinic@email.com)",
          label: "Clinic email for demo",
          validate: (v) => isValidEmail(v) || "Please enter a valid email address."
        });
      }

      steps.push({
        key: "service",
        bot: "What do you need help with today?",
        placeholder: "Choose a service‚Ä¶",
        label: "Service",
        quick: [
          "Checkup / cleaning",
          "Tooth pain / emergency",
          "Filling / cavity",
          "Root canal",
          "Extraction",
          "Braces / orthodontics",
          "Whitening",
          "Implants",
          "Kids dentistry",
          "Other"
        ],
        validate: (v) => String(v).trim().length > 1 || "Please choose a service."
      });

      steps.push({
        key: "patientName",
        bot: "Thanks. What‚Äôs your full name?",
        placeholder: "Type your name",
        label: "Full name",
        validate: (v) => String(v).trim().length >= 2 || "Please enter your name."
      });

      steps.push({
        key: "patientPhone",
        bot: "Great. What phone number should we call or WhatsApp?",
        placeholder: "e.g. 0712 345 678",
        label: "Phone number",
        validate: (v) => String(v).trim().length >= 7 || "Please enter a phone number."
      });

      steps.push({
        key: "patientEmail",
        bot: "Optional: what email address should we use (if any)?\n(You can type ‚Äúskip‚Äù to continue.)",
        placeholder: "Type email or 'skip'",
        label: "Email (optional)",
        validate: (v) => {
          const t = String(v).trim().toLowerCase();
          if (t === "skip" || t === "") return true;
          return isValidEmail(v) || "Please enter a valid email, or type 'skip'.";
        }
      });

      steps.push({
        key: "preferredTime",
        bot: "When do you prefer to be contacted?",
        placeholder: "Choose a time‚Ä¶",
        label: "Preferred contact time",
        quick: ["Morning", "Afternoon", "Evening", "Anytime"],
        validate: (v) => String(v).trim().length > 1 || "Please choose a preferred time."
      });

      steps.push({
        key: "notes",
        bot: "Any extra notes for the clinic? (Symptoms, duration, urgency)\n(You can type ‚Äúnone‚Äù.)",
        placeholder: "Type notes‚Ä¶",
        label: "Notes",
        validate: (v) => String(v).trim().length >= 2 || "Please type a short note (or 'none')."
      });
    }
          function start() {
      buildSteps();
      addMsg("Hi üëã I‚Äôll help you request a dental appointment.");
      if (isDemo) {
        addMsg("This is a demo. You‚Äôll enter a clinic email first, then complete the patient chat.");
      }
      askCurrentStep();
    }

    function askCurrentStep() {
      const step = steps[stepIndex];
      if (!step) return;

      addMsg(step.bot, "bot");

      if (step.quick) {
        setQuickButtons(step.quick);
        // Also allow typing
        setInput(step.placeholder || "Type here‚Ä¶", step.label || "Your answer");
      } else {
        setQuickButtons(null);
        setInput(step.placeholder || "Type here‚Ä¶", step.label || "Your answer");
      }
    }

    function handleAnswer(ansRaw) {
      const step = steps[stepIndex];
      if (!step) return;

      const ans = String(ansRaw || "").trim();

      // Validate
      const ok = step.validate ? step.validate(ans) : true;
      if (ok !== true) {
        addMsg("‚ùó " + ok, "bot");
        return;
      }

      // Store
      if (step.key === "patientEmail") {
        const t = ans.toLowerCase();
        state.patientEmail = (t === "skip" || t === "") ? "" : ans;
      } else if (step.key === "patientPhone") {
        state.patientPhone = normalizePhone(ans);
      } else {
        state[step.key] = ans;
      }

      // Next
      stepIndex++;

      if (stepIndex < steps.length) {
        askCurrentStep();
      } else {
        finishAndSend();
      }
    }

    async function finishAndSend() {
      setQuickButtons(null);
      addMsg("Perfect. Sending your request to the clinic now‚Ä¶ ‚úÖ", "bot");

      const payload = {
        submittedAt: new Date().toISOString(),
        mode: state.mode,
        demoEmail: state.demoEmail || "",
        service: state.service || "",
        patientName: state.patientName || "",
        patientPhone: state.patientPhone || "",
        patientEmail: state.patientEmail || "",
        preferredTime: state.preferredTime || "",
        notes: state.notes || "",
        sourcePage: state.sourcePage || ""
      };

      try {
        // Using no-cors to avoid browser CORS blocking
        // ---- routing params (demo / clinic) ----
const params = new URLSearchParams(location.search);
const isDemo = params.get("demo") === "1";
const clinic = (params.get("clinic") || "").trim();

// Add routing to payload
payload.mode = isDemo ? "DEMO" : "LIVE";
if (clinic) payload.clinic = clinic;

await fetch(MAILER_URL, {
  method: "POST",
  mode: "no-cors",
  headers: { "Content-Type": "text/plain;charset=utf-8" },
  body: JSON.stringify(payload)
});
        await fetch(MAILER_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        if (isDemo) {
          addMsg(
            "‚úÖ Demo email sent to: " + state.demoEmail +
            "\n\nIf you didn‚Äôt receive it, check Spam/Junk. You can run the demo again anytime.",
            "bot"
          );
        } else {
          addMsg("‚úÖ Sent. The clinic will contact you soon.", "bot");
        }

        addMsg(
          "Summary:\n" +
          "‚Ä¢ Service: " + state.service + "\n" +
          "‚Ä¢ Name: " + state.patientName + "\n" +
          "‚Ä¢ Phone: " + state.patientPhone + "\n" +
          "‚Ä¢ Preferred time: " + state.preferredTime,
          "bot"
        );

        // Offer restart
        addMsg("Would you like to submit another request?", "bot");
        setQuickButtons(["Start again"]);
        const btn = quickEl.querySelector(".qbtn");
        if (btn) {
          btn.onclick = () => {
            quickEl.style.display = "none";
            resetChat();
          };
        }
      } catch (err) {
        addMsg("‚ùó Something went wrong while sending. Please try again in a moment.", "bot");
      }
    }

    function resetChat() {
      // Clear chat UI + restart state (keep demo mode)
      chatEl.innerHTML = "";
      stepIndex = 0;

      state.service = "";
      state.patientName = "";
      state.patientPhone = "";
      state.patientEmail = "";
      state.preferredTime = "";
      state.notes = "";

      // Keep demoEmail in demo so they don‚Äôt retype
      if (!isDemo) state.demoEmail = "";

      start();
    }

    // =========================
    // EVENTS
    // =========================
    function onSend() {
      const v = inputEl.value.trim();
      if (!v) return;
      addMsg(v, "user");
      setQuickButtons(null);
      handleAnswer(v);
    }

    sendBtn.addEventListener("click", onSend);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        onSend();
      }
    });

    // Start the chat
    start();
  </script>
  </body>
</html>
