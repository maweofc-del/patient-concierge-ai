<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Concierge AI ‚Äî Chat</title>
  <meta name="description" content="AI dental booking assistant that collects patient details and sends them to the clinic instantly." />
  <style>
    :root{
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.12);
      --shadow:0 18px 60px rgba(2,6,23,.10);
      --brand:#2563eb;
      --brand2:#0ea5e9;
      --ok:#16a34a;
      --warn:#b45309;
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 20% 0%, #e9fff7, transparent 55%),
        radial-gradient(900px 600px at 80% 0%, #eef4ff, transparent 55%),
        linear-gradient(180deg,#fbfdff,#f6fffb);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .wrap{width:min(1020px,100%); display:grid; grid-template-columns: 1fr 420px; gap:16px;}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .topbar{
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg,#ffffff,#fbfdff);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid; place-items:center;
      color:#fff; font-weight:900; letter-spacing:.5px;
      box-shadow:0 12px 30px rgba(37,99,235,.22);
      user-select:none;
    }
    .brandTitle{font-weight:900; line-height:1.1;}
    .brandSub{color:var(--muted); font-size:12px;}
    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.8);
      white-space:nowrap;
    }

    .chatArea{display:flex; flex-direction:column; height: 690px;}
    @media (max-width:980px){ .chatArea{height: 72vh;} }

    .messages{
      padding:14px 14px 0;
      overflow:auto;
      flex:1 1 auto;
    }
    .msgRow{display:flex; margin:10px 0;}
    .msgRow.bot{justify-content:flex-start;}
    .msgRow.user{justify-content:flex-end;}

    .bubble{
      max-width: 86%;
      padding:11px 12px;
      border-radius:16px;
      font-size:14px;
      line-height:1.35;
      border:1px solid var(--border);
      white-space:pre-wrap;
    }
    .bot .bubble{background:#f1f5ff; border-color: rgba(37,99,235,.18);}
    .user .bubble{background:#ecfeff; border-color: rgba(14,165,233,.18);}

    /* Option chips (tap buttons) */
    .chips{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      padding:10px 14px 12px;
      border-top:1px solid rgba(15,23,42,.06);
      background:#ffffff;
    }
    .chip{
      appearance:none;
      border:1px solid var(--border);
      background:#fff;
      border-radius:999px;
      padding:9px 12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      user-select:none;
    }
    .chip:hover{border-color: rgba(37,99,235,.35);}
    .chip:disabled{opacity:.55; cursor:not-allowed;}

    .composer{
      border-top:1px solid var(--border);
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background:#ffffff;
    }
    textarea{
      width:100%;
      resize:none;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      min-height:44px;
      max-height:120px;
    }
    textarea:focus{border-color: rgba(37,99,235,.35);}
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:11px 14px;
      border-radius:14px;
      font-weight:900;
      color:#fff;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); filter:brightness(1.02)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}
        /* Right panel */
    .side{padding:16px 16px 18px;}
    .side h2{margin:0 0 8px; font-size:16px;}
    .side p{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.55;}
    .box{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fbfdff;
      margin-top:10px;
    }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .field{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .field:focus{border-color: rgba(37,99,235,.35);}
    .small{font-size:12px; color:var(--muted); margin-top:8px;}
    .ok{color:var(--ok); font-weight:800;}
    .warn{color:var(--warn); font-weight:800;}
    .hr{height:1px; background:var(--border); margin:12px 0;}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card chatArea">
      <div class="topbar">
        <div class="brand">
          <div class="logo">PC</div>
          <div>
            <div class="brandTitle">Patient Concierge AI</div>
            <div class="brandSub" id="modeLine">Dental booking assistant</div>
          </div>
        </div>
        <div class="pill" id="pill">‚óè Online</div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <textarea id="input" placeholder="Type here‚Ä¶" rows="1"></textarea>
        <button class="btn" id="sendBtn">Send</button>
      </div>

      <!-- Chips appear below composer for easy tapping -->
      <div class="chips" id="chips" style="display:none;"></div>
    </div>

    <div class="card side">
      <h2>Booking Intake</h2>
      <p>Fast appointment request ‚Äî details are sent to the clinic instantly.</p>

      <div class="box" id="demoBox" style="display:none;">
        <div class="label">Demo email (receive your test booking)</div>
        <input class="field" id="demoEmail" type="email" placeholder="name@clinic.com" />
        <div class="small" id="demoHint" style="display:none;">
          <span class="ok">Demo mode:</span> Enter your clinic email above to receive a test booking summary.
        </div>
      </div>

      <div class="box">
        <div class="label">Status</div>
        <div class="small" id="statusLine"><span class="ok">Ready.</span></div>
      </div>
    </div>
  </div>

  <script>
    // Apps Script Web App URL (/exec)
    const MAILER_URL = "https://script.google.com/macros/s/AKfycbwobfSvAaRJi7XKOekFQf5a7uVDIFaYwdsFkHnEsn35sQNFWgsZQtzwqNJAaGNxRcEE/exec";

    // Routing from URL
    const params = new URLSearchParams(location.search);
    const isDemo = params.get("demo") === "1";
    const clinic = (params.get("clinic") || "").trim().toLowerCase();

    const demoBox = document.getElementById("demoBox");
    const modeLine = document.getElementById("modeLine");
    const pill = document.getElementById("pill");
    const demoHint = document.getElementById("demoHint");

    if (isDemo) {
      demoBox.style.display = "block";
      demoHint.style.display = "block";
      modeLine.textContent = "Demo mode";
      pill.textContent = "‚óè Demo";
    } else if (clinic) {
      modeLine.textContent = "Clinic mode";
      pill.textContent = "‚óè Live";
    } else {
      modeLine.textContent = "Live mode";
      pill.textContent = "‚óè Live";
    }

    const messagesEl = document.getElementById("messages");
    const chipsEl = document.getElementById("chips");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const statusLine = document.getElementById("statusLine");

    const state = {
      step: 0,
      service: "",
      patientName: "",
      patientPhone: "",
      patientEmail: "",
      preferredTime: "",
      contactMethod: "",
      notes: "",
      demoEmail: "",
      submitting: false
    };

    function addMsg(text, who="bot") {
      const row = document.createElement("div");
      row.className = "msgRow " + who;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(html) {
      statusLine.innerHTML = html;
    }

    function mailerUrlLooksValid() {
      return typeof MAILER_URL === "string" && MAILER_URL.startsWith("https://script.google.com/macros/s/");
    }

    function normalizePhone(s) {
      return String(s || "").replace(/[^\d+]/g,"").trim();
    }

    function disableChips(disabled) {
      Array.from(chipsEl.querySelectorAll("button")).forEach(b => b.disabled = !!disabled);
    }

    function showChips(options) {
      chipsEl.innerHTML = "";
      if (!options || !options.length) {
        chipsEl.style.display = "none";
        return;
      }
      chipsEl.style.display = "flex";
      options.forEach(label => {
        const b = document.createElement("button");
        b.className = "chip";
        b.type = "button";
        b.textContent = label;
        b.addEventListener("click", () => {
          if (state.submitting) return;
          addMsg(label, "user");
          handleUser(label);
        });
        chipsEl.appendChild(b);
      });
    }
        const SERVICES = [
      "Check-up",
      "Cleaning",
      "Toothache / Pain",
      "Filling",
      "Root canal",
      "Braces / Orthodontics",
      "Whitening",
      "Implant",
      "Dentures",
      "Extraction",
      "Emergency"
    ];

    const TIMES = ["Morning", "Afternoon", "Evening"];
    const CONTACT = ["WhatsApp", "Call", "Email"];
    const SKIP = ["Skip"];

    function askNext() {
      if (state.step === 0) {
        addMsg("Hi üëã I‚Äôll help you book a dental appointment.");
        addMsg("What service do you need?");
        showChips(SERVICES);
        state.step = 1;
        return;
      }

      if (state.step === 1) {
        showChips([]); // hide chips for typing
        addMsg("Great ‚Äî what‚Äôs your full name?");
        state.step = 2;
        return;
      }

      if (state.step === 2) {
        addMsg("What‚Äôs the best phone number to reach you on?");
        state.step = 3;
        return;
      }

      if (state.step === 3) {
        addMsg("Do you have an email? (optional)");
        showChips(SKIP);
        state.step = 4;
        return;
      }

      if (state.step === 4) {
        addMsg("Preferred contact time?");
        showChips(TIMES);
        state.step = 5;
        return;
      }

      if (state.step === 5) {
        addMsg("How should the clinic contact you?");
        showChips(CONTACT);
        state.step = 6;
        return;
      }

      if (state.step === 6) {
        addMsg("Any notes/symptoms to share? (optional)");
        showChips(SKIP);
        state.step = 7;
        return;
      }

      if (state.step === 7) {
        showChips([]); // hide chips during submit
        submitPayload();
        return;
      }
    }

    function handleUser(text) {
      const t = String(text || "").trim();
      if (!t) return;

      // Step routing
      if (state.step === 1) {
        state.service = t;
        askNext();
        return;
      }

      if (state.step === 2) {
        state.patientName = t;
        askNext();
        return;
      }

      if (state.step === 3) {
        state.patientPhone = normalizePhone(t);
        askNext();
        return;
      }

      if (state.step === 4) {
        if (/^skip$/i.test(t)) state.patientEmail = "";
        else state.patientEmail = t;
        askNext();
        return;
      }

      if (state.step === 5) {
        state.preferredTime = t;
        askNext();
        return;
      }

      if (state.step === 6) {
        state.contactMethod = t;
        askNext();
        return;
      }

      if (state.step === 7) {
        if (/^skip$/i.test(t)) state.notes = "";
        else state.notes = t;
        askNext();
        return;
      }

      // If user types before starting
      if (state.step === 0) {
        addMsg("No problem ‚Äî let‚Äôs start ‚úÖ");
        askNext();
      }
    }

    function makeSubmissionId() {
      return Date.now() + "-" + Math.random().toString(16).slice(2);
    }

    async function submitPayload() {
      // HARD lock: prevents double send
      if (state.submitting) return;
      state.submitting = true;

      // lock UI
      sendBtn.disabled = true;
      inputEl.disabled = true;
      disableChips(true);

      if (isDemo) {
        const de = document.getElementById("demoEmail").value.trim();
        state.demoEmail = de;
        if (!de) {
          addMsg("Please enter your clinic email on the right to receive the demo booking ‚úÖ", "bot");
          setStatus('<span class="warn">Demo email required.</span>');
          state.submitting = false;
          sendBtn.disabled = false;
          inputEl.disabled = false;
          disableChips(false);
          // show service chips again so user can continue smoothly
          showChips(SERVICES);
          state.step = 1;
          return;
        }
      }

      if (!mailerUrlLooksValid()) {
        addMsg("‚ö†Ô∏è Setup issue: the server link isn‚Äôt configured correctly.", "bot");
        setStatus('<span class="warn">Server not configured.</span>');
        state.submitting = false;
        sendBtn.disabled = false;
        inputEl.disabled = false;
        disableChips(false);
        return;
      }

      const payload = {
        submissionId: makeSubmissionId(),
        mode: isDemo ? "DEMO" : "LIVE",
        clinic: clinic || "",
        demoEmail: isDemo ? state.demoEmail : "",
        service: state.service,
        patientName: state.patientName,
        patientPhone: state.patientPhone,
        patientEmail: state.patientEmail,
        preferredTime: state.preferredTime,
        contactMethod: state.contactMethod,
        notes: state.notes,
        sourcePage: location.href,
        submittedAt: new Date().toISOString()
      };

      setStatus('<span class="ok">Sending‚Ä¶</span>');
      addMsg("‚úÖ Thanks ‚Äî submitting your request now‚Ä¶", "bot");

      try {
        await fetch(MAILER_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        addMsg("‚úÖ Submitted successfully. The clinic will contact you shortly.", "bot");
        setStatus('<span class="ok">Sent.</span>');
      } catch (err) {
        addMsg("‚ö†Ô∏è Something went wrong sending the request. Please try again.", "bot");
        setStatus('<span class="warn">Send failed.</span>');
      } finally {
        state.submitting = false;
        sendBtn.disabled = false;
        inputEl.disabled = false;
        disableChips(false);
        showChips([]); // keep clean after submit
      }
    }
        function sendNow() {
      const text = inputEl.value;
      inputEl.value = "";
      inputEl.style.height = "44px";
      addMsg(text, "user");
      handleUser(text);
    }

    // Button click
    sendBtn.addEventListener("click", () => {
      const v = inputEl.value.trim();
      if (!v) return;
      if (state.submitting) return;
      sendNow();
    });

    // Enter to send
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        const v = inputEl.value.trim();
        if (!v) return;
        if (state.submitting) return;
        sendNow();
      }
    });

    // Auto-grow textarea
    inputEl.addEventListener("input", () => {
      inputEl.style.height = "44px";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
    });

    // Start the flow
    addMsg("Hi üëã Welcome to Patient Concierge AI.");
    addMsg("Tap an option below to begin, or type your request.");
    askNext();
  </script>
</body>
</html>
