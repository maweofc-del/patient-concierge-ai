<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Concierge AI ‚Äî Chat</title>
  <meta name="description" content="AI dental booking assistant that collects patient details and sends them to the clinic instantly." />

  <style>
    :root{
      --bg:#f6fbff;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#475569;
      --border:rgba(15,23,42,.12);
      --shadow:0 18px 60px rgba(2,6,23,.10);
      --brand:#2563eb;
      --brand2:#0ea5e9;
      --ok:#16a34a;
      --warn:#b45309;
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background:
        radial-gradient(900px 600px at 20% 0%, #e9fff7, transparent 55%),
        radial-gradient(900px 600px at 80% 0%, #eef4ff, transparent 55%),
        linear-gradient(180deg,#fbfdff,#f6fffb);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    a{color:inherit}
    .wrap{width:min(980px,100%); display:grid; grid-template-columns: 1fr 420px; gap:16px;}
    @media (max-width: 980px){ .wrap{grid-template-columns:1fr; } }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .topbar{
      padding:16px 18px;
      border-bottom:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      background: linear-gradient(180deg,#ffffff,#fbfdff);
    }
    .brand{display:flex; align-items:center; gap:10px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      display:grid; place-items:center;
      color:#fff; font-weight:900; letter-spacing:.5px;
      box-shadow:0 12px 30px rgba(37,99,235,.22);
      user-select:none;
    }
    .brandTitle{font-weight:900; line-height:1.1;}
    .brandSub{color:var(--muted); font-size:12px;}

    .pill{
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      color:var(--muted);
      background:rgba(255,255,255,.8);
      white-space:nowrap;
    }

    /* Chat */
    .chatArea{display:flex; flex-direction:column; height: 640px;}
    @media (max-width:980px){ .chatArea{height: 70vh;} }

    .messages{
      padding:14px 14px 0;
      overflow:auto;
      flex:1 1 auto;
    }
    .msgRow{display:flex; margin:10px 0;}
    .msgRow.bot{justify-content:flex-start;}
    .msgRow.user{justify-content:flex-end;}

    .bubble{
      max-width: 86%;
      padding:11px 12px;
      border-radius:16px;
      font-size:14px;
      line-height:1.35;
      border:1px solid var(--border);
    }
    .bot .bubble{
      background:#f1f5ff;
      border-color: rgba(37,99,235,.18);
    }
    .user .bubble{
      background:#ecfeff;
      border-color: rgba(14,165,233,.18);
    }
    .meta{
      font-size:11px;
      color:var(--muted);
      margin-top:4px;
    }

    .composer{
      border-top:1px solid var(--border);
      padding:12px;
      display:flex;
      gap:10px;
      align-items:flex-end;
      background:#ffffff;
    }
    textarea{
      width:100%;
      resize:none;
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      min-height:44px;
      max-height:120px;
    }
    textarea:focus{border-color: rgba(37,99,235,.35);}
    .btn{
      appearance:none; border:0; cursor:pointer;
      padding:11px 14px;
      border-radius:14px;
      font-weight:900;
      color:#fff;
      background: linear-gradient(135deg,var(--brand),var(--brand2));
      transition: transform .08s ease, filter .2s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); filter:brightness(1.02)}
    .btn:disabled{opacity:.55; cursor:not-allowed; transform:none;}
        /* Side panel */
    .side{padding:16px 16px 18px;}
    .side h2{margin:0 0 8px; font-size:16px;}
    .side p{margin:0 0 12px; color:var(--muted); font-size:13px; line-height:1.55;}
    .box{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background:#fbfdff;
      margin-top:10px;
    }
    .label{font-size:12px; color:var(--muted); margin-bottom:6px;}
    .field{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px 10px;
      font-size:14px;
      outline:none;
      background:#fff;
    }
    .field:focus{border-color: rgba(37,99,235,.35);}
    .small{font-size:12px; color:var(--muted); margin-top:8px;}
    .ok{color:var(--ok); font-weight:800;}
    .warn{color:var(--warn); font-weight:800;}
    .hr{height:1px; background:var(--border); margin:12px 0;}

    .quickBtns{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px;}
    .qbtn{
      padding:9px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      cursor:pointer;
      font-size:13px;
      font-weight:800;
    }
    .qbtn:hover{border-color: rgba(37,99,235,.35);}
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card chatArea">
      <div class="topbar">
        <div class="brand">
          <div class="logo">PC</div>
          <div>
            <div class="brandTitle">Patient Concierge AI</div>
            <div class="brandSub" id="modeLine">Dental booking assistant</div>
          </div>
        </div>
        <div class="pill" id="pill">‚óè Online</div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <textarea id="input" placeholder="Type here‚Ä¶" rows="1"></textarea>
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </div>

    <div class="card side">
      <h2>Booking Intake</h2>
      <p>This assistant collects patient details and sends them to the clinic instantly.</p>

      <div class="box" id="demoBox" style="display:none;">
        <div class="label">Demo email (where you want to receive the test booking)</div>
        <input class="field" id="demoEmail" type="email" placeholder="name@clinic.com" />
        <div class="small">Used only for the demo test. Real clinics have their own routing.</div>
      </div>

      <div class="box">
        <div class="label">Quick actions</div>
        <div class="quickBtns">
          <button class="qbtn" data-quick="Start booking">Start booking</button>
          <button class="qbtn" data-quick="Pricing">Pricing</button>
          <button class="qbtn" data-quick="How it works">How it works</button>
        </div>
        <div class="hr"></div>
        <div class="small">
          <span class="ok">Tip:</span> Demo link is <b>?demo=1</b>. Clinic link is <b>?clinic=smileart</b>.
        </div>
      </div>

      <div class="box">
        <div class="label">Status</div>
        <div class="small" id="statusLine"><span class="ok">Ready.</span></div>
      </div>
    </div>
  </div>

  <script>
    /*********************************************************
     * IMPORTANT: paste your Apps Script Web App EXEC URL here
     *********************************************************/
    const MAILER_URL = https://script.google.com/macros/s/AKfycbwobfSvAaRJi7XKOekFQf5a7uVDIFaYwdsFkHnEsn35sQNFWgsZQtzwqNJAaGNxRcEE/exec;

    // Routing from URL
    const params = new URLSearchParams(location.search);
    const isDemo = params.get("demo") === "1";
    const clinic = (params.get("clinic") || "").trim().toLowerCase();

    // UI setup
    const demoBox = document.getElementById("demoBox");
    const modeLine = document.getElementById("modeLine");
    const pill = document.getElementById("pill");
    if (isDemo) {
      demoBox.style.display = "block";
      modeLine.textContent = "Demo mode ‚Ä¢ sends to your email";
      pill.textContent = "‚óè Demo";
    } else if (clinic) {
      modeLine.textContent = "Clinic mode ‚Ä¢ " + clinic;
      pill.textContent = "‚óè Live";
    } else {
      modeLine.textContent = "Live mode ‚Ä¢ booking assistant";
      pill.textContent = "‚óè Live";
    }

    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const statusLine = document.getElementById("statusLine");

    const state = {
      step: 0,
      service: "",
      patientName: "",
      patientPhone: "",
      patientEmail: "",
      preferredTime: "",
      contactMethod: "",
      notes: "",
      demoEmail: ""
    };

    function addMsg(text, who="bot") {
      const row = document.createElement("div");
      row.className = "msgRow " + who;
      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setStatus(html) {
      statusLine.innerHTML = html;
    }
        // Simple script validation
    function mailerUrlLooksValid() {
      return typeof MAILER_URL === "string" && MAILER_URL.startsWith("https://script.google.com/macros/s/");
    }

    function normalizePhone(s) {
      return String(s || "").replace(/[^\d+]/g,"").trim();
    }

    function askNext() {
      // Step-based intake
      if (state.step === 0) {
        addMsg("Hi üëã I‚Äôll help you book a dental appointment. What service do you need?");
        addMsg("Examples: Check-up, Cleaning, Filling, Root Canal, Braces, Whitening, Toothache, Implant, Emergency.");
        state.step = 1;
        return;
      }
      if (state.step === 1) {
        addMsg("Great ‚Äî what‚Äôs your full name?");
        state.step = 2;
        return;
      }
      if (state.step === 2) {
        addMsg("What‚Äôs the best phone number to reach you on?");
        state.step = 3;
        return;
      }
      if (state.step === 3) {
        addMsg("Do you have an email you‚Äôd like us to use? (optional ‚Äî type ‚Äúskip‚Äù if not)");
        state.step = 4;
        return;
      }
      if (state.step === 4) {
        addMsg("When would you prefer to be contacted? (Morning / Afternoon / Evening)");
        state.step = 5;
        return;
      }
      if (state.step === 5) {
        addMsg("How should the clinic contact you? (WhatsApp / Call / Email)");
        state.step = 6;
        return;
      }
      if (state.step === 6) {
        addMsg("Any notes or symptoms to share? (optional ‚Äî type ‚Äúskip‚Äù if none)");
        state.step = 7;
        return;
      }
      if (state.step === 7) {
        // Ready to submit
        submitPayload();
        return;
      }
    }

    function handleUser(text) {
      const t = String(text || "").trim();
      if (!t) return;

      // quick menu
      if (/^pricing$/i.test(t)) {
        addMsg("Pricing (Kenya): Intro month KSh 7,500 then KSh 10,000/month per clinic. Cancel anytime.");
        addMsg("To activate for your clinic, we set a private dashboard + clinic link.");
        return;
      }
      if (/^how it works$/i.test(t)) {
        addMsg("How it works: A patient chats for 60 seconds ‚Üí clinic receives an email summary ‚Üí it saves to a private Google Sheets dashboard for follow-up.");
        return;
      }
      if (/^start booking$/i.test(t)) {
        if (state.step === 0) askNext();
        else addMsg("We‚Äôre already booking ‚úÖ please answer the last question.");
        return;
      }

      // Intake steps
      if (state.step === 1) { state.service = t; askNext(); return; }
      if (state.step === 2) { state.patientName = t; askNext(); return; }
      if (state.step === 3) { state.patientPhone = normalizePhone(t); askNext(); return; }
      if (state.step === 4) {
        if (/^skip$/i.test(t)) state.patientEmail = "";
        else state.patientEmail = t;
        askNext(); return;
      }
      if (state.step === 5) { state.preferredTime = t; askNext(); return; }
      if (state.step === 6) { state.contactMethod = t; askNext(); return; }
      if (state.step === 7) {
        if (/^skip$/i.test(t)) state.notes = "";
        else state.notes = t;
        askNext(); return;
      }

      // If user types before starting
      if (state.step === 0) {
        addMsg("No problem ‚Äî let‚Äôs start ‚úÖ");
        askNext();
      }
    }

    async function submitPayload() {
      // Demo email requirement
      if (isDemo) {
        const de = document.getElementById("demoEmail").value.trim();
        state.demoEmail = de;
        if (!de) {
          addMsg("Please enter a demo email on the right panel first ‚úÖ", "bot");
          setStatus('<span class="warn">Demo email required.</span>');
          return;
        }
      }

      if (!mailerUrlLooksValid()) {
        addMsg("‚ö†Ô∏è Setup issue: MAILER_URL is not set correctly.", "bot");
        addMsg("Please paste your Apps Script /exec link into chat.html (MAILER_URL).", "bot");
        setStatus('<span class="warn">MAILER_URL not set.</span>');
        return;
      }

      // Build payload (matches Apps Script router)
      const payload = {
        mode: isDemo ? "DEMO" : "LIVE",
        clinic: clinic || "",
        demoEmail: isDemo ? state.demoEmail : "",
        service: state.service,
        patientName: state.patientName,
        patientPhone: state.patientPhone,
        patientEmail: state.patientEmail,
        preferredTime: state.preferredTime,
        contactMethod: state.contactMethod,
        notes: state.notes,
        sourcePage: location.href,
        submittedAt: new Date().toISOString()
      };

      // UX lock
      sendBtn.disabled = true;
      setStatus('<span class="ok">Sending‚Ä¶</span>');

      try {
        addMsg("‚úÖ Thanks ‚Äî submitting your request now‚Ä¶", "bot");

        await fetch(MAILER_URL, {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body: JSON.stringify(payload)
        });

        addMsg("‚úÖ Submitted successfully. The clinic will contact you shortly.", "bot");
        setStatus('<span class="ok">Sent.</span>');
      } catch (err) {
        addMsg("‚ö†Ô∏è Something went wrong sending the request. Please try again.", "bot");
        setStatus('<span class="warn">Send failed.</span>');
      } finally {
        sendBtn.disabled = false;
      }
    }
        // Send button + enter handling
    function sendNow() {
      const text = inputEl.value;
      inputEl.value = "";
      inputEl.style.height = "44px";
      addMsg(text, "user");
      handleUser(text);
    }

    sendBtn.addEventListener("click", () => {
      if (!inputEl.value.trim()) return;
      sendNow();
    });

    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        if (!inputEl.value.trim()) return;
        sendNow();
      }
    });

    inputEl.addEventListener("input", () => {
      inputEl.style.height = "44px";
      inputEl.style.height = Math.min(inputEl.scrollHeight, 120) + "px";
    });

    // Quick buttons
    document.querySelectorAll(".qbtn").forEach(btn => {
      btn.addEventListener("click", () => {
        const t = btn.getAttribute("data-quick");
        addMsg(t, "user");
        handleUser(t);
      });
    });

    // Start conversation
    addMsg("Hi üëã Welcome to Patient Concierge AI.");
    addMsg("Tap ‚ÄúStart booking‚Äù or tell me what you need.");
  </script>
</body>
</html>
